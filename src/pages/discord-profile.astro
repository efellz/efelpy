---
import Layout from '../layouts/Layout.astro';
---

<Layout title="Discord User Profile Viewer">
  <div class="max-w-4xl mx-auto">
    <h1 class="text-4xl font-bold mb-8">Discord User Profile Viewer</h1>

    <!-- Token Input Form -->
    <div class="bg-gray-800 rounded-lg p-6 mb-8">
      <h2 class="text-2xl font-semibold mb-4">Enter Bot Token</h2>
      <div class="space-y-4">
        <div>
          <label for="token" class="block text-sm font-medium mb-2">Discord Bot Token</label>
          <input
            type="password"
            id="token"
            placeholder="Your bot token..."
            class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
          />
          <p class="text-sm text-gray-400 mt-1">Your token is never stored and only used for the API request.</p>
        </div>
        <button
          id="fetchBtn"
          class="btn btn-lg w-full sm:w-auto"
        >
          Fetch Profile
        </button>
        <div id="error" class="hidden text-red-400 p-3 bg-red-900/20 rounded"></div>
      </div>
    </div>

    <!-- Loading State -->
    <div id="loading" class="hidden text-center py-12">
      <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500"></div>
      <p class="mt-4 text-gray-400">Fetching user data...</p>
    </div>

    <!-- Profile Display -->
    <div id="profile" class="hidden">
      <!-- Banner -->
      <div class="relative">
        <div id="banner" class="w-full h-48 bg-gradient-to-br from-blue-600 to-purple-600 rounded-t-lg"></div>
        <div class="absolute -bottom-16 left-6">
          <div class="relative">
            <img
              id="avatar"
              src=""
              alt="User Avatar"
              class="w-32 h-32 rounded-full border-8 border-gray-900"
            />
            <div id="status-indicator" class="absolute bottom-2 right-2 w-8 h-8 rounded-full border-4 border-gray-900"></div>
          </div>
        </div>
      </div>

      <!-- Profile Info -->
      <div class="bg-gray-800 rounded-b-lg p-6 pt-20">
        <div class="space-y-4">
          <!-- Username and Badges -->
          <div class="flex items-center gap-3">
            <h2 id="username" class="text-3xl font-bold"></h2>
            <div id="badges" class="flex gap-2"></div>
          </div>

          <!-- User Info Grid -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-6">
            <div class="bg-gray-700 p-4 rounded-lg">
              <div class="text-sm text-gray-400 mb-1">User ID</div>
              <div id="userId" class="font-mono text-lg"></div>
            </div>

            <div class="bg-gray-700 p-4 rounded-lg">
              <div class="text-sm text-gray-400 mb-1">Display Name</div>
              <div id="displayName" class="text-lg"></div>
            </div>

            <div class="bg-gray-700 p-4 rounded-lg">
              <div class="text-sm text-gray-400 mb-1">Account Created</div>
              <div id="accountCreated" class="text-lg"></div>
            </div>

            <div class="bg-gray-700 p-4 rounded-lg">
              <div class="text-sm text-gray-400 mb-1">Bot Account</div>
              <div id="isBot" class="text-lg"></div>
            </div>
          </div>

          <!-- Bio Section -->
          <div id="bioSection" class="hidden bg-gray-700 p-4 rounded-lg mt-4">
            <div class="text-sm text-gray-400 mb-2">About Me</div>
            <div id="bio" class="text-base whitespace-pre-wrap"></div>
          </div>

          <!-- Public Flags -->
          <div id="flagsSection" class="hidden bg-gray-700 p-4 rounded-lg mt-4">
            <div class="text-sm text-gray-400 mb-2">Profile Badges</div>
            <div id="flags" class="flex flex-wrap gap-2"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Info Box -->
    <div class="mt-8 bg-blue-900/20 border border-blue-500/30 rounded-lg p-4">
      <p class="text-sm text-gray-300">
        <strong>Note:</strong> This tool fetches information for user ID <code class="bg-gray-700 px-2 py-1 rounded">757335355644051656</code>.
        Status and presence information requires a WebSocket Gateway connection and cannot be fetched via REST API.
        The bot needs appropriate permissions to view user data.
      </p>
    </div>
  </div>
</Layout>

<script>
  const USER_ID = '757335355644051656';

  const fetchBtn = document.getElementById('fetchBtn') as HTMLButtonElement;
  const tokenInput = document.getElementById('token') as HTMLInputElement;
  const errorDiv = document.getElementById('error') as HTMLDivElement;
  const loadingDiv = document.getElementById('loading') as HTMLDivElement;
  const profileDiv = document.getElementById('profile') as HTMLDivElement;

  // Discord User Flags
  const FLAGS = {
    1: { name: 'Discord Employee', color: 'bg-blue-600' },
    2: { name: 'Partnered Server Owner', color: 'bg-purple-600' },
    4: { name: 'HypeSquad Events', color: 'bg-green-600' },
    8: { name: 'Bug Hunter Level 1', color: 'bg-green-500' },
    64: { name: 'House Bravery', color: 'bg-purple-500' },
    128: { name: 'House Brilliance', color: 'bg-pink-500' },
    256: { name: 'House Balance', color: 'bg-teal-500' },
    512: { name: 'Early Supporter', color: 'bg-pink-600' },
    16384: { name: 'Bug Hunter Level 2', color: 'bg-green-600' },
    131072: { name: 'Verified Bot Developer', color: 'bg-blue-500' },
    4194304: { name: 'Active Developer', color: 'bg-green-500' }
  };

  fetchBtn.addEventListener('click', async () => {
    const token = tokenInput.value.trim();

    if (!token) {
      showError('Please enter a bot token');
      return;
    }

    // Hide error and profile, show loading
    errorDiv.classList.add('hidden');
    profileDiv.classList.add('hidden');
    loadingDiv.classList.remove('hidden');

    try {
      const response = await fetch('/.netlify/functions/discord-user', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          token: token,
          userId: USER_ID
        })
      });

      const data = await response.json();

      if (!response.ok) {
        throw new Error(data.error || 'Failed to fetch user data');
      }

      displayProfile(data);
      loadingDiv.classList.add('hidden');
      profileDiv.classList.remove('hidden');

    } catch (error) {
      loadingDiv.classList.add('hidden');
      showError(error instanceof Error ? error.message : 'An error occurred');
    }
  });

  function showError(message: string) {
    errorDiv.textContent = message;
    errorDiv.classList.remove('hidden');
  }

  function displayProfile(data: any) {
    // Avatar
    const avatarImg = document.getElementById('avatar') as HTMLImageElement;
    avatarImg.src = data.avatar_url;

    // Banner
    if (data.banner_url) {
      const bannerDiv = document.getElementById('banner') as HTMLDivElement;
      bannerDiv.style.backgroundImage = `url(${data.banner_url})`;
      bannerDiv.style.backgroundSize = 'cover';
      bannerDiv.style.backgroundPosition = 'center';
    } else if (data.accent_color) {
      const bannerDiv = document.getElementById('banner') as HTMLDivElement;
      const color = '#' + data.accent_color.toString(16).padStart(6, '0');
      bannerDiv.style.background = color;
    }

    // Status indicator (default to offline since we can't get real status)
    const statusIndicator = document.getElementById('status-indicator') as HTMLDivElement;
    statusIndicator.classList.add('bg-gray-500'); // Offline/Unknown

    // Username
    const usernameEl = document.getElementById('username') as HTMLHeadingElement;
    if (data.global_name) {
      usernameEl.textContent = data.global_name;
    } else {
      usernameEl.textContent = data.username;
    }

    // User ID
    const userIdEl = document.getElementById('userId') as HTMLDivElement;
    userIdEl.textContent = data.id;

    // Display Name
    const displayNameEl = document.getElementById('displayName') as HTMLDivElement;
    displayNameEl.textContent = data.global_name || data.username;

    // Account Created
    const accountCreatedEl = document.getElementById('accountCreated') as HTMLDivElement;
    const timestamp = Number(BigInt(data.id) >> BigInt(22)) + 1420070400000;
    const date = new Date(timestamp);
    accountCreatedEl.textContent = date.toLocaleDateString('en-US', {
      year: 'numeric',
      month: 'long',
      day: 'numeric'
    });

    // Is Bot
    const isBotEl = document.getElementById('isBot') as HTMLDivElement;
    isBotEl.textContent = data.bot ? 'Yes' : 'No';

    // Bio
    if (data.profile?.bio) {
      const bioSection = document.getElementById('bioSection') as HTMLDivElement;
      const bioEl = document.getElementById('bio') as HTMLDivElement;
      bioEl.textContent = data.profile.bio;
      bioSection.classList.remove('hidden');
    }

    // Flags/Badges
    if (data.public_flags && data.public_flags > 0) {
      const flagsSection = document.getElementById('flagsSection') as HTMLDivElement;
      const flagsEl = document.getElementById('flags') as HTMLDivElement;
      flagsEl.innerHTML = '';

      for (const [flag, info] of Object.entries(FLAGS)) {
        const flagValue = parseInt(flag);
        if (data.public_flags & flagValue) {
          const badge = document.createElement('span');
          badge.className = `px-3 py-1 rounded-full text-sm font-medium ${info.color} text-white`;
          badge.textContent = info.name;
          flagsEl.appendChild(badge);
        }
      }

      if (flagsEl.children.length > 0) {
        flagsSection.classList.remove('hidden');
      }
    }
  }
</script>

<style>
  input:focus {
    outline: none;
  }
</style>
